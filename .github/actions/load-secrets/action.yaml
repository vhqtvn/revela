name: Load Secrets from GCP Secrets Manager

inputs:
  expose_env:
    description: "Expose the secrets also as environment variables (default: false). For safety reasons it's recommended to use explicit outputs than environment variables."
    required: false
    default: "false"
outputs:
  AWS_ACCOUNT_NUM:
    value: ${{ steps.secrets.outputs.AWS_ACCOUNT_NUM }}
  AWS_ACCESS_KEY_ID:
    value: ${{ steps.secrets.outputs.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY:
    value: ${{ steps.secrets.outputs.AWS_SECRET_ACCESS_KEY }}
  PUSH_GATEWAY:
    value: ${{ steps.secrets.outputs.PUSH_GATEWAY }}
  PUSH_GATEWAY_USER: 
    value: ${{ steps.secrets.outputs.PUSH_GATEWAY_USER }}
  PUSH_GATEWAY_PASSWORD: 
    value: ${{ steps.secrets.outputs.PUSH_GATEWAY_PASSWORD }}
  NPM_JS_AUTH_TOKEN:
    value: ${{ steps.secrets.outputs.NPM_JS_AUTH_TOKEN }}
  GCP_DOCKER_ARTIFACT_REPO:
    value: ${{ steps.secrets.outputs.GCP_DOCKER_ARTIFACT_REPO }}

runs:
  using: composite
  steps:
    - id: "secrets"
      uses: "google-github-actions/get-secretmanager-secrets@v0"
      with:
        secrets: |-
          AWS_ACCOUNT_NUM:aptos-ci/AWS_ACCOUNT_NUM
          AWS_ACCESS_KEY_ID:aptos-ci/AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY:aptos-ci/AWS_SECRET_ACCESS_KEY
          PUSH_GATEWAY:aptos-ci/PUSH_GATEWAY
          PUSH_GATEWAY_USER:aptos-ci/PUSH_GATEWAY_USER
          PUSH_GATEWAY_PASSWORD:aptos-ci/PUSH_GATEWAY_PASSWORD
          NPM_JS_AUTH_TOKEN:aptos-ci/NPM_JS_AUTH_TOKEN
          GCP_DOCKER_ARTIFACT_REPO:aptos-ci/GCP_DOCKER_ARTIFACT_REPO

    - name: Expose secrets as environment variables
      if: inputs.expose_env == 'true'
      shell: bash
      run: |
        echo "AWS_ACCOUNT_NUM=${{ steps.secrets.outputs.AWS_ACCOUNT_NUM }}" >> $GITHUB_ENV
        echo "AWS_ACCESS_KEY_ID=${{ steps.secrets.outputs.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=${{ steps.secrets.outputs.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
        echo "PUSH_GATEWAY=${{ steps.secrets.outputs.PUSH_GATEWAY }}" >> $GITHUB_ENV
        echo "PUSH_GATEWAY_USER=${{ steps.secrets.outputs.PUSH_GATEWAY_USER }}" >> $GITHUB_ENV
        echo "PUSH_GATEWAY_PASSWORD=${{ steps.secrets.outputs.PUSH_GATEWAY_PASSWORD }}" >> $GITHUB_ENV
        echo "NPM_JS_AUTH_TOKEN=${{ steps.secrets.outputs.NPM_JS_AUTH_TOKEN }}" >> $GITHUB_ENV
        echo "GCP_DOCKER_ARTIFACT_REPO=${{ steps.secrets.outputs.GCP_DOCKER_ARTIFACT_REPO }}" >> $GITHUB_ENV
